<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduTimer - Manajemen Waktu Belajar</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 text-gray-900 p-4">

  <!-- Tombol Aktifkan Notifikasi (User Gesture) -->
  <div class="flex justify-end mb-4">
    <button id="enableNotifBtn" class="bg-teal-500 text-white px-4 py-2 rounded shadow hover:bg-teal-600">
      Aktifkan Notifikasi
    </button>
  </div>

  <!-- Konten Utama -->
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-8 relative">
    
    <!-- Bagian Timer -->
    <div id="timerSection" class="mb-8">
      <div id="timer" class="text-5xl font-bold text-white bg-red-500 p-6 rounded-lg shadow-md text-center">
        25:00
      </div>
      <!-- Tombol Timer + Tombol Mode Fokus -->
      <div class="flex flex-wrap justify-center gap-4 mt-4">
        <button id="startBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Mulai</button>
        <button id="pauseBtn" class="bg-yellow-500 text-white px-6 py-2 rounded-lg shadow hover:bg-yellow-600">Pause</button>
        <button id="resetBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg shadow hover:bg-red-600">Reset</button>
        <button id="focusModeBtn" class="bg-indigo-500 text-white px-6 py-2 rounded-lg shadow hover:bg-indigo-600">Mode Fokus</button>
      </div>
    </div>

    <!-- Pengaturan Waktu Belajar -->
    <form id="settingsForm" class="nonFocus mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-2">Pengaturan Waktu Belajar</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-600">Waktu Belajar (menit):</label>
          <input id="studyTime" type="number" min="1" value="25" class="mt-1 border rounded w-full p-2" required />
        </div>
        <div>
          <label class="block text-gray-600">Waktu Istirahat (menit):</label>
          <input id="breakTime" type="number" min="1" value="5" class="mt-1 border rounded w-full p-2" required />
        </div>
      </div>
      <button id="saveSettings" type="submit" class="bg-green-500 text-white px-6 py-2 rounded-lg shadow mt-4 hover:bg-green-600">
        Simpan Pengaturan
      </button>
    </form>

    <!-- Pengaturan Jam Mulai Belajar per Hari -->
    <div id="startTimeSection" class="nonFocus mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-2">Pengaturan Jam Mulai Belajar</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select id="startDay" class="border p-2 rounded w-full">
          <option value="" disabled selected>Pilih Hari</option>
          <option value="Senin">Senin</option>
          <option value="Selasa">Selasa</option>
          <option value="Rabu">Rabu</option>
          <option value="Kamis">Kamis</option>
          <option value="Jumat">Jumat</option>
          <option value="Sabtu">Sabtu</option>
          <option value="Minggu">Minggu</option>
        </select>
        <input id="startTime" type="time" class="border p-2 rounded w-full" />
      </div>
      <button id="saveStartTime" class="bg-blue-500 text-white px-6 py-2 rounded-lg shadow mt-4 hover:bg-blue-600">
        Simpan Jam Belajar
      </button>
    </div>

    <!-- Tambah Tugas -->
    <div id="tasksSection" class="nonFocus mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-2">Tambah Tugas</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Input Mapel -->
        <input id="taskMapel" type="text" placeholder="Mapel (misal: IPA, MTK, dll.)" class="border p-2 rounded w-full" />
        <!-- Input Tugas -->
        <input id="taskDescription" type="text" placeholder="Tugas (misal: Mencatat Bab 1)" class="border p-2 rounded w-full" />
        <!-- Input Deadline (tanggal lengkap) -->
        <input id="taskDeadline" type="date" class="border p-2 rounded w-full" />
      </div>
      <button id="addTask" class="bg-blue-500 text-white px-6 py-2 rounded-lg shadow mt-4 hover:bg-blue-600">
        Tambah Tugas
      </button>
      <ul id="taskList" class="mt-4 space-y-2"></ul>
    </div>

    <!-- Jadwal Pelajaran -->
    <div id="scheduleSection" class="nonFocus">
      <h2 class="text-xl font-semibold text-gray-700 mb-2">Jadwal Pelajaran</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="subjectInput" type="text" placeholder="Nama Mapel..." class="border p-2 rounded w-full" />
        <select id="subjectDay" class="border p-2 rounded w-full">
          <option value="" disabled selected>Pilih Hari</option>
          <option value="Senin">Senin</option>
          <option value="Selasa">Selasa</option>
          <option value="Rabu">Rabu</option>
          <option value="Kamis">Kamis</option>
          <option value="Jumat">Jumat</option>
          <option value="Sabtu">Sabtu</option>
          <option value="Minggu">Minggu</option>
        </select>
      </div>
      <button id="addSubject" class="bg-purple-500 text-white px-6 py-2 rounded-lg shadow mt-4 hover:bg-purple-600">
        Tambah Pelajaran
      </button>
      <div class="mt-4">
        <h3 class="text-lg font-semibold text-gray-700" id="scheduleTitle">Jadwal untuk hari ini</h3>
        <ul id="subjectList" class="mt-2 space-y-2"></ul>
      </div>
    </div>

  </div>

  <script>
    // =================== TOMBOL AKTIFKAN NOTIFIKASI (USER GESTURE) ===================
    const enableNotifBtn = document.getElementById('enableNotifBtn');
    enableNotifBtn.addEventListener('click', () => {
      if ("Notification" in window) {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            new Notification("Notifikasi diizinkan!", {
              body: "Sekarang notifikasi dapat muncul di desktop/mobile.",
              icon: "https://via.placeholder.com/128"
            });
          } else {
            console.log("Notifikasi tidak diizinkan oleh user.");
          }
        });
      } else {
        Swal.fire({
          title: "Not Supported",
          text: "Browser ini tidak mendukung Notification API.",
          icon: "error",
          confirmButtonText: "OK"
        });
      }
    });

    // =================== FUNGSI UTAMA NOTIFIKASI ===================
    function sendNotification(title, options) {
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, options);
      } else {
        Swal.fire({ title, text: options.body, icon: options.icon || "info", confirmButtonText: "OK" });
      }
    }

    // =================== TIMER LOGIC (Time-based) ===================
    const endSound = new Audio('assets/musics/end.mp3');
    let timerElement = document.getElementById('timer');
    let startBtn = document.getElementById('startBtn');
    let pauseBtn = document.getElementById('pauseBtn');
    let resetBtn = document.getElementById('resetBtn');
    let studyTimeInput = document.getElementById('studyTime');
    let breakTimeInput = document.getElementById('breakTime');
    let settingsForm = document.getElementById('settingsForm');

    let studyDuration = parseInt(studyTimeInput.value) * 60;
    let breakDuration = parseInt(breakTimeInput.value) * 60;
    let timeInSeconds = studyDuration;
    let isRunning = false;
    let isStudySession = true;
    let sessionStartTimestamp = null;
    let sessionEndTimestamp = null;
    let timerInterval = null;

    function formatTime(seconds) {
      let m = Math.floor(seconds / 60).toString().padStart(2, '0');
      let s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function updateTimerElement() {
      timerElement.innerText = formatTime(timeInSeconds);
    }

    function updateTimerBackground() {
      if (isStudySession) {
        timerElement.classList.remove('bg-green-500');
        timerElement.classList.add('bg-red-500');
      } else {
        timerElement.classList.remove('bg-red-500');
        timerElement.classList.add('bg-green-500');
      }
    }

    function checkTime() {
      let now = Date.now();
      let diff = sessionEndTimestamp - now;
      if (diff <= 0) {
        clearInterval(timerInterval);
        isRunning = false;
        timeInSeconds = 0;
        updateTimerElement();
        switchSession();
      } else {
        timeInSeconds = Math.ceil(diff / 1000);
        updateTimerElement();
      }
    }

    function startTimer() {
      if (!isRunning) {
        sessionStartTimestamp = Date.now();
        sessionEndTimestamp = sessionStartTimestamp + (timeInSeconds * 1000);
        timerInterval = setInterval(checkTime, 500);
        isRunning = true;
      }
    }

    function pauseTimer() {
      if (isRunning) {
        clearInterval(timerInterval);
        isRunning = false;
      }
    }

    function resetTimer() {
      pauseTimer();
      isStudySession = true;
      timeInSeconds = studyDuration;
      updateTimerBackground();
      updateTimerElement();
    }

    function showAlert(title, text, icon='info') {
      return Swal.fire({
        title: title,
        text: text,
        icon: icon,
        confirmButtonText: 'OK'
      });
    }

    function switchSession() {
      endSound.play().catch(err => {
        console.log("Audio belum bisa diputar otomatis:", err);
      });
      if (isStudySession) {
        isStudySession = false;
        timeInSeconds = breakDuration;
        updateTimerBackground();
        updateTimerElement();
        showAlert('Waktu belajar selesai!', 'Mulai istirahat.', 'success')
          .then((result) => {
            if (result.isConfirmed) {
              startTimer();
            }
          });
      } else {
        isStudySession = true;
        timeInSeconds = studyDuration;
        updateTimerBackground();
        updateTimerElement();
        showAlert('Istirahat selesai!', 'Mulai belajar.', 'success')
          .then((result) => {
            if (result.isConfirmed) {
              startTimer();
            }
          });
      }
    }

    settingsForm.addEventListener('submit', (e) => {
      e.preventDefault();
      studyDuration = parseInt(studyTimeInput.value) * 60;
      breakDuration = parseInt(breakTimeInput.value) * 60;
      resetTimer();
      showAlert('Pengaturan Disimpan', 'Waktu belajar & istirahat telah diperbarui.', 'success');
    });

    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);

    updateTimerElement();
    updateTimerBackground();

    // =================== DATA & VARIABEL TUGAS & JADWAL ===================
    let subjectSchedule = [];
    let tasks = [];

    // =================== BAGIAN TUGAS ===================
    let taskMapelInput = document.getElementById('taskMapel');
    let taskDescriptionInput = document.getElementById('taskDescription');
    let taskDeadlineInput = document.getElementById('taskDeadline');
    let addTaskBtn = document.getElementById('addTask');
    let taskList = document.getElementById('taskList');

    function displayAllTasks() {
      taskList.innerHTML = "";
      if (tasks.length === 0) {
        taskList.innerHTML = `<li class="bg-gray-200 p-2 rounded">Belum ada tugas.</li>`;
        return;
      }
      tasks.forEach((t, index) => {
        let li = document.createElement('li');
        li.className = "bg-gray-200 p-2 rounded flex justify-between items-center";
        let deadlineText = t.deadline ? new Date(t.deadline).toLocaleDateString() : '-';
        li.innerHTML = `
          <div>
            <span class="font-semibold">${t.mapel}</span> - ${t.tugas}<br>
            <small class="text-gray-600">Deadline: ${deadlineText}</small>
          </div>
        `;
        let deleteBtn = document.createElement('button');
        deleteBtn.innerText = "X";
        deleteBtn.className = "text-red-500 ml-2";
        deleteBtn.onclick = () => {
          tasks.splice(index, 1);
          displayAllTasks();
          displaySubjects();
        };
        li.appendChild(deleteBtn);
        taskList.appendChild(li);
      });
    }

    addTaskBtn.addEventListener('click', () => {
      let mapelVal = taskMapelInput.value.trim();
      let tugasVal = taskDescriptionInput.value.trim();
      let deadlineVal = taskDeadlineInput.value;
      if (mapelVal && tugasVal && deadlineVal) {
        tasks.push({ mapel: mapelVal, tugas: tugasVal, deadline: deadlineVal, deadlineNotified: false });
        taskMapelInput.value = "";
        taskDescriptionInput.value = "";
        taskDeadlineInput.value = "";
        displayAllTasks();
        displaySubjects();
      } else {
        showAlert('Gagal Menambah Tugas', 'Masukkan mapel, tugas, dan deadline dengan benar.', 'error');
      }
    });

    // =================== BAGIAN JADWAL PELAJARAN ===================
    let subjectInput = document.getElementById('subjectInput');
    let subjectDaySelect = document.getElementById('subjectDay');
    let addSubjectBtn = document.getElementById('addSubject');
    let subjectList = document.getElementById('subjectList');
    let scheduleTitle = document.getElementById('scheduleTitle');

    addSubjectBtn.addEventListener('click', () => {
      let subjectText = subjectInput.value.trim();
      let subjectDay = subjectDaySelect.value;
      if (subjectText && subjectDay) {
        subjectSchedule.push({ subject: subjectText, day: subjectDay });
        subjectInput.value = "";
        subjectDaySelect.selectedIndex = 0;
        displaySubjects();
      } else {
        showAlert('Gagal Menambah Pelajaran', 'Masukkan nama mapel dan pilih hari dengan benar.', 'error');
      }
    });

    const daysMap = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    function getCurrentScheduleDay() {
      let now = new Date();
      if (now.getHours() >= 18) {
        now.setDate(now.getDate() + 1);
      }
      return daysMap[now.getDay()];
    }

    function displaySubjects() {
      subjectList.innerHTML = "";
      let displayDay = getCurrentScheduleDay();
      scheduleTitle.innerText = `Jadwal untuk hari ${displayDay}`;
      let filtered = subjectSchedule.filter(item => item.day === displayDay);
      if (filtered.length === 0) {
        subjectList.innerHTML = `<li class='bg-gray-200 p-2 rounded'>Tidak ada jadwal untuk hari ini.</li>`;
      } else {
        filtered.forEach(item => {
          let li = document.createElement('li');
          li.className = "bg-gray-200 p-2 rounded mb-2";
          let subjectHtml = `<div class="font-semibold text-lg">${item.subject}</div>`;
          // Tampilkan tugas jika mapel sama dan jika deadline (hari dari deadline) sama dengan jadwal
          let matchedTasks = tasks.filter(t => {
            if (!t.deadline) return false;
            let taskDay = daysMap[new Date(t.deadline).getDay()];
            return t.mapel.toLowerCase() === item.subject.toLowerCase() && taskDay === item.day;
          });
          if (matchedTasks.length > 0) {
            subjectHtml += `<ul class="ml-4 mt-1 list-disc">`;
            matchedTasks.forEach(taskItem => {
              let deadlineText = new Date(taskItem.deadline).toLocaleDateString();
              subjectHtml += `
                <li class="mt-1">
                  <span class="text-gray-800">Tugas: ${taskItem.tugas}</span>
                  <small class="text-gray-600"> (Deadline: ${deadlineText})</small>
                </li>
              `;
            });
            subjectHtml += `</ul>`;
          } else {
            subjectHtml += `<div class="text-sm text-gray-600 ml-4 mt-1 italic">Tidak ada tugas</div>`;
          }
          li.innerHTML = subjectHtml;
          subjectList.appendChild(li);
        });
      }
    }

    displayAllTasks();
    displaySubjects();

    // =================== MODE FOKUS ===================
    let isFocusMode = false;
    let focusModeBtn = document.getElementById('focusModeBtn');
    focusModeBtn.addEventListener('click', toggleFocusMode);
    function toggleFocusMode() {
      isFocusMode = !isFocusMode;
      document.querySelectorAll('.nonFocus').forEach(el => {
        el.classList.toggle('hidden', isFocusMode);
      });
      focusModeBtn.innerText = isFocusMode ? "Keluar Mode Fokus" : "Mode Fokus";
    }

    // =================== NOTIFIKASI PUSH ===================
    function checkTaskDeadlineNotifications() {
      let now = new Date();
      tasks.forEach(task => {
        if (task.deadline && !task.deadlineNotified) {
          let deadlineDate = new Date(task.deadline);
          deadlineDate.setHours(23,59,59,999);
          let diffSeconds = (deadlineDate.getTime() - now.getTime()) / 1000;
          if (diffSeconds <= 3600 && diffSeconds > 0) {
            sendNotification("Tugas Mendekati Deadline", {
              body: `Tugas "${task.tugas}" pada ${task.mapel} mendekati deadline!`,
              icon: "https://via.placeholder.com/128"
            });
            task.deadlineNotified = true;
          }
        }
      });
    }

    function checkStudyStartNotification() {
      let now = new Date();
      let currentDay = daysMap[now.getDay()];
      if (studyStartTimes[currentDay] && !isRunning && isStudySession) {
        let [setHour, setMinute] = studyStartTimes[currentDay].split(':').map(Number);
        let targetTime = new Date(now);
        targetTime.setHours(setHour, setMinute, 0, 0);
        let diffSeconds = (targetTime.getTime() - now.getTime()) / 1000;
        if (diffSeconds > 0 && diffSeconds <= 300) {
          sendNotification("Pengingat Belajar", {
            body: "5 menit lagi mulai waktu belajar!",
            icon: "https://via.placeholder.com/128"
          });
        }
      }
    }

    let studyStartTimes = {}; 
    let saveStartTimeBtn = document.getElementById('saveStartTime');
    let startDaySelect = document.getElementById('startDay');
    let startTimeInput = document.getElementById('startTime');
    saveStartTimeBtn.addEventListener('click', () => {
      let day = startDaySelect.value;
      let time = startTimeInput.value;
      if (day && time) {
        studyStartTimes[day] = time;
        showAlert('Jam Belajar Disimpan', `Jam belajar untuk ${day} disetel ke ${time}.`, 'success');
      } else {
        showAlert('Gagal', 'Pilih hari dan masukkan jam belajar dengan benar.', 'error');
      }
    });

    setInterval(checkTaskDeadlineNotifications, 60000);  // setiap menit
    setInterval(checkStudyStartNotification, 30000);       // setiap 30 detik
  </script>
</body>
</html>
